<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>БОО «АДАПТИВНІСТЬ-200» — інтерактивний тест</title>
  <style>
    :root{
      --bg:#0b0c10;--card:#121318;--ink:#e9edf1;--muted:#9ba3ae;--brand:#4da3ff;--accent:#20c997;--warn:#ffcc00;--danger:#ff6363;--ok:#2ecc71;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0c10 0%, #10121a 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .wrap{max-width:1100px;margin-inline:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(20px,2.5vw,28px);margin:0}
    .card{background:var(--card);border:1px solid #1d2030;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.35);}
    .section{padding:20px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){
        .grid.cols-2{grid-template-columns:1fr}
        .q {
            flex-direction: column;
        }
        .q-text {
            width: 100%;
            min-width: 100%;
        }
        .q-actions {
            width: 100%;
            min-width: 100%;
            justify-content: end;
        }
        header .pill{
            display: none!important
        }
        #controlsRuntime .grid{
               grid-template-columns: repeat(1, minmax(0, 1fr))!important;
        }
      }

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:1px solid #2a2f42;background:#151826;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1e40af}
    .btn.ghost{background:transparent}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#15803d}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#b45309}

    .progress{height:10px;background:#1a1f2b;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#22d3ee,#4f46e5);width:0%}

    .q{padding:14px 16px;border-bottom:1px solid #1a1f2b;display:flex;gap:10px;align-items:flex-start}
    .q.no-border{border-bottom:0}
    .q-num{min-width:42px;inline-size:42px;block-size:42px;background:#0f1320;border:1px solid #1a1f2b;color:#a8b3c7;border-radius:10px;display:grid;place-items:center;font-weight:700}
    .q-text{flex:1;line-height:1.5}
    .q-actions{display:flex;gap:8px}
    .choice{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #2a2f42;border-radius:12px;background:#0e1220;cursor:pointer;user-select:none}
    .choice input{accent-color:#4da3ff}

    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(13,16,28,.0), rgba(13,16,28,.8)), var(--card);border-top:1px solid #1a1f2b;border-bottom-left-radius:16px;border-bottom-right-radius:16px;padding:12px 16px}

    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px 12px;border-bottom:1px solid #1b2030;text-align:left}
    thead th{position:sticky;top:0;background:#121626;z-index:1}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;border:1px solid #223}
    .pill.bad{border-color:#5b2730;background:#2a1418;color:#ffb4c0}
    .pill.good{border-color:#144b2f;background:#0f241a;color:#b9ffd7}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .hide{display:none}
    .summary{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.summary{grid-template-columns:1fr}}
    .kpi{padding:12px;border-radius:12px;border:1px solid #1b2030;background:#0f1320}
    .kpi .k{font-size:12px;color:#9aa6b2}
    .kpi .v{font-size:28px;font-weight:800}

    .note{font-size:13px;color:#9aa6b2}
    details{background:#0f1320;border:1px solid #1b2030;padding:12px;border-radius:12px}
    details>summary{cursor:pointer;font-weight:700}

    /* Друкований (PDF) режим — бланк */
    @media print{
        @page{
          size: A4;           /* або auto */
          margin: 6mm;        /* постав 0–6mm; 0 дає найменші поля */
        }
      body{background:#fff;color:#000}
      .wrap{max-width:980px}
      .card,.section{background:#fff;border:1px solid #000}
      header, .toolbar, .sticky-footer, #controlsRuntime, #summary, #scalesTable{display:none!important}
        #controlsRuntime, #controlsRuntime *,
        #questions, #questions *,
        .hide-results, .hide-results *
        {
            display: none!important;
            visibility: hidden!important;
            height: 0!important
        }
        thead th,.kpi {
            background: #fff!important
        }
      #printSheet{display:block!important}
      .print-title{font-weight:800;text-align:center;margin-bottom:6px}
      .print-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
      .print-box{border:1px solid #000;padding:8px;border-radius:0}
      .print-table{width:100%;border-collapse:collapse}
      .print-table th,.print-table td{border:1px solid #000;padding:6px 8px;text-align:left}
      .print-note{font-size:12px}
        body{ margin:0; }               /* на всяк випадок */
  .wrap{ max-width:none; padding:0; }
  .card,.section{ border:1px solid #000; padding:8px; } /* було більше — зменши */
  #printSheet{ margin:0; padding:0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>БОО «АДАПТИВНІСТЬ-200» — інтерактивний тест</h1>
      <div class="pill">Формат відповіді: <strong>Так / Ні</strong></div>
    </header>

    <!-- Панель керування / загальні відомості -->
    <div id="controlsRuntime" class="card" style="margin-bottom:12px">
      <div class="section grid cols-2">
        <div>
          <h3 style="margin:0 0 8px 0">Загальні відомості</h3>
          <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">
            <input id="fi" class="btn" placeholder="Прізвище" />
            <input id="im" class="btn" placeholder="Ім'я" />
            <input id="po" class="btn" placeholder="По батькові" />
            <input id="dob" class="btn" placeholder="Дата нар. (ДД.ММ.РРРР)" />
            <input id="unit" class="btn" placeholder="В/ч або підрозділ" />
            <input id="date" class="btn" placeholder="Дата тестування (ДД.ММ.РРРР)" />
          </div>
        </div>
        <div class="grid">
          <div>
            <div class="progress" aria-label="Прогрес проходження"><div id="progressBar" class="bar"></div></div>
            <div class="muted" style="margin-top:8px">Відповіли: <span id="answered">0</span>/200</div>
          </div>
          <div class="toolbar">
            <button class="btn ghost" id="btnPrev">← Попередні 10</button>
            <button class="btn ghost" id="btnNext">Наступні 10 →</button>
            <button class="btn primary" id="btnFinish">Підрахувати результати</button>
            <button class="btn" id="btnClear">Очистити відповіді</button>
            <button class="btn warn" id="btnResetAll">Розпочати спочатку</button>
            <button class="btn success" id="btnExportPDF">Експорт у PDF</button>
          </div>
          <div class="note">Стан тесту зберігається автоматично у вашому браузері (localStorage). Можна закривати сторінку і продовжити пізніше.</div>
        </div>
      </div>
    </div>

    <!-- Блок питань -->
    <div class="card hide-results">
      <div class="section grid cols-2">
        <div>
          <p class="muted">Опитувальник для оцінки адаптаційних можливостей. Відповідайте «Так» або «Ні» без довгих роздумів.</p>
          <details>
            <summary>Коротка інструкція</summary>
            <p>Погоджуєтесь — «Так». Не згодні — «Ні». Після завершення натисніть «Підрахувати результати».</p>
            <p class="note">За шкалою достовірності (Д) ≥10 інтерпретації не відображаються.</p>
          </details>
        </div>
        <div class="grid">
          <div>
            <div class="progress" aria-label="Прогрес"><div id="progressBar2" class="bar" style="width:0%"></div></div>
            <div class="muted" style="margin-top:8px">Поточний блок: 10 питань</div>
          </div>
          <div class="toolbar">
            <button class="btn ghost" id="btnPrev2">← Попередні 10</button>
            <button class="btn ghost" id="btnNext2">Наступні 10 →</button>
            <button class="btn success" id="btnFinish2">Підрахувати результати</button>
          </div>
        </div>
      </div>
      <div id="questions" class="section" role="group" aria-label="Питання"></div>
      <div class="sticky-footer">
        <div class="toolbar">
          <span class="muted">Показуємо блоки по 10 запитань</span>
          <div class="spacer" style="flex:1"></div>
          <button class="btn ghost" id="btnPrev3">← Попередні 10</button>
          <button class="btn ghost" id="btnNext3">Наступні 10 →</button>
          <button class="btn success" id="btnFinish3">Підрахувати результати</button>
        </div>
      </div>
    </div>

    <!-- Результати + бланк друку -->
    <div id="results" class="card hide" style="margin-top:16px">
      <div class="section">
        <h2 style="margin-top:0">Результати</h2>
        <div id="validityBlock" class="hide">
          <p class="pill bad">Попередження: Достовірність (Д) ≥ 10 — решта шкал не інтерпретуються.</p>
        </div>
        <div id="summary" class="summary" style="margin-top:10px"></div>
      </div>
      <div class="section">
        <h3>Таблиця шкал (сирі бали → стени)</h3>
        <div class="note" style="margin-bottom:10px">ОАП = ПР + КП + МН. ВПС, ДАП, СР — окремо.</div>
        <div style="overflow:auto">
          <table id="scalesTable">
            <thead>
              <tr><th>Шкала</th><th>Сирі бали</th><th>Стен</th><th>Інтерпретація</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="section">
        <h3>Таблиця 4-го рівня (ОАП → стени → рівень стійкості)</h3>
        <table>
          <thead><tr><th>ОАП (сирі)</th><th>Стен</th><th>Рівень стійкості до бойового стресу</th><th>Опис</th></tr></thead>
          <tbody id="oapRow"></tbody>
        </table>
      </div>
      <div class="section">
        <h3>Пояснення до результатів</h3>
        <p class="note">Нижче — розгорнуті описи для кожної шкали з урахуванням вашого стену.</p>
        <div id="narratives" class="grid cols-2"></div>
      </div>
      <div class="section">
        <h3>Дані для бланку та експорт</h3>
        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">
          <input id="fi2" class="btn" placeholder="Прізвище" />
          <input id="im2" class="btn" placeholder="Ім'я" />
          <input id="po2" class="btn" placeholder="По батькові" />
          <input id="dob2" class="btn" placeholder="Дата нар. (ДД.ММ.РРРР)" />
          <input id="unit2" class="btn" placeholder="В/ч або підрозділ" />
          <input id="date2" class="btn" placeholder="Дата тестування (ДД.ММ.РРРР)" />
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn success" id="btnExportPDF2">Експорт у PDF</button>
          <button class="btn warn" id="btnResetAll2">Розпочати спочатку</button>
          <button class="btn" id="btnSave">Завантажити JSON (локально)</button>
          <input type="file" id="fileLoad" accept="application/json" />
        </div>
      </div>

      <!-- PRINT SHEET — відображається лише у режимі друку -->
      <div id="printSheet" class="hide section">
        <div class="print-title">КАРТКА СОЦІАЛЬНО-ПСИХОЛОГІЧНОГО ВИВЧЕННЯ ВІЙСЬКОВОСЛУЖБОВЦЯ</div>
        <div class="print-grid">
          <div class="print-box">
            <div><strong>ЗАГАЛЬНІ ВІДОМОСТІ</strong></div>
            <div>Прізвище: <span id="p_fi"></span></div>
            <div>Ім'я: <span id="p_im"></span></div>
            <div>По батькові: <span id="p_po"></span></div>
            <div>Дата нар.: <span id="p_dob"></span></div>
            <div>Підрозділ: <span id="p_unit"></span></div>
            <div>Дата тестування: <span id="p_date"></span></div>
          </div>
          <div class="print-box print-note"><strong>Примітка:</strong> Результати «АДАПТИВНІСТЬ-200». За Д ≥ 10 інтерпретація не надається.</div>
        </div>
        <div class="print-box" style="margin-top:8px">
          <strong>БОО «АДАПТИВНІСТЬ-200»</strong>
          <table class="print-table" style="margin-top:6px">
            <thead><tr><th>Шкала</th><th>Сирі</th><th>Стен</th><th>Короткий висновок</th></tr></thead>
            <tbody id="printScales"></tbody>
          </table>
        </div>
        <div class="print-box" style="margin-top:8px">
          <table class="print-table">
            <thead><tr><th>ОАП (ПР+КП+МН)</th><th>Стен</th><th>Рівень стійкості</th><th>Коментар</th></tr></thead>
            <tbody id="printOAP"></tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="muted" style="margin-top:16px">
      Версія: 2025-09. Реалізація сторінки суто інформативна і не замінює професійну психодіагностику.
    </footer>
  </div>

  <script>
  // === Дані опитувальника ===
  const QUESTIONS = {
   1:"Буває, що я серджуся",
  2:"Зазвичай вранці я прокидаюся свіжим і відпочилим",
  3:"Зараз я приблизно так само працездатний, як і завжди",
  4:"Доля безумовно несправедлива до мене",
  5:"Запори у мене бувають дуже рідко",
  6:"Часом мені дуже хотілося покинути свій дім",
  7:"Часом у мене бувають напади сміху або плачу, з якими я ніяк не можу справитися",
  8:"Мені здається, що мене ніхто не розуміє",
  9:"Вважаю, що якщо хтось заподіяв мені зло, я повинен йому відповісти тим же",
  10:"Іноді мені в голову приходять такі нехороші думки, що краще про них нікому не розказувати",
  11:"Мені важко зосередитися на якому-небудь завданні або роботі",
  12:"У мене бувають дуже дивні і незвичайні переживання",
  13:"У мене були відсутні неприємності через мою поведінку",
  14:"В дитинстві я у свій час скоював дрібні крадіжки",
  15:"Буває, у мене з’являється бажання ламати або крушити все навколо",
  16:"Бувало, що я цілими днями або навіть тижнями нічого не міг робити, тому що ніяк не міг примусити себе взятися до роботи",
  17:"Сон у мене переривистий і неспокійний",
  18:"Моя сім'я відноситися з несхваленням до тієї роботи, яку я обрав",
  19:"Бували випадки, що я не виконував своїх обіцянок",
  20:"Голова у мене болить часто",
  21:"Раз на тиждень або частіше я без жодної видимої причини раптово відчуваю жар у всьому тілі",
  22:"Було б добре, якби майже всі закони відмінили",
  23:"Стан мого здоров’я майже такий же, як у більшості моїх знайомих (не гірше)",
  24:"Зустрічаючи на вулиці своїх знайомих або шкільних друзів, з якими я давно не бачився, я вважаю за краще проходити мимо, якщо вони зі мною не заговорюють першими",
  25:"Більшості людей, які мене знають, я подобаюся",
  26:"Я людина товариська",
  27:"Іноді я так наполягаю на своєму, що люди втрачають терпіння",
  28:"Значну частину часу настрій у мене пригнічений",
  29:"Тепер мені важко сподіватися на те, що я чого-небудь досягну у житті",
  30:"У мене мало впевненості в собі",
  31:"Іноді я кажу неправду",
  32:"Зазвичай я вважаю, що життя – гарна річ",
  33:"Я вважаю, що більшість людей здатна збрехати, щоб просунутися по службі",
  34:"Я охоче беру участь у зібраннях, зборах і інших суспільних заходах",
  35:"Я сварюся з членами моєї сім’ї дуже рідко",
  36:"Іноді у мене виникає сильне бажання порушити правила пристойності або кому-небудь нашкодити",
  37:"Найважча боротьба для мене - це боротьба з самим собою",
  38:"М’язові судоми або сіпання у мене бувають украй рідко (або майже не бувають)",
  39:"Я досить байдужий до того, що зі мною буде",
  40:"Іноді, коли я себе недобре відчуваю я буваю дратівливим, ",
  41:"Значну частину часу у мене таке відчуття, що я зробив щось не те або навіть щось погане",
  42:"Деякі люди до того полюбляють командувати, що мені так і кортить робити все наперекір, навіть якщо я знаю, що вони мають рацію",
  43:"Я часто вважаю себе зобов'язаним відстоювати те, що вважаю справедливим",
  44:"Моя мова зараз така ж як завжди (ні швидше і ні повільніше, немає ні хрипоти, ні невиразності)",
  45:"Я вважаю, що моє сімейне життя таке ж добре, як у більшості моїх знайомих",
  46:"Мене вкрай зачіпає, коли мене критикують або лають",
  47:"Іноді у мене буває таке відчуття, що я просто повинен нанести ушкодження собі або кому-небудь іншому",
  48:"Моя поведінка значною мірою визначається звичаями тих, хто мене оточує",
  49:"В дитинстві у мене була така компанія, де всі прагнули стояти один за одного",
  50:"Іноді мені так і кортить з ким-небудь затіяти бійку",
  51:"Бувало, що я казав про речі, в яких не розбираюся",
  52:"Зазвичай я засинаю спокійно і мене не турбують ніякі думки",
  53:"Останні декілька років я відчуваю себе добре",
  54:"У мене ніколи не було ні припадків, ні судом",
  55:"Зараз моя вага постійна (я не худну і не повнішаю)",
  56:"Я вважаю, що мене часто карали нізащо",
  57:"Я легко плачу",
  58:"Я мало втомлююся",
  59:"Я був би досить спокійний, якби у кого-небудь з моєї сім'ї були неприємності через порушення закону",
  60:"З моїм розумом творитися щось недобре",
  61:"Щоб приховати свою сором'язливість мені доводиться докладати великі зусилля.",
  62:"Напади запаморочення у мене бувають дуже рідко (або майже не бувають)",
  63:"Мене турбують сексуальні (статеві) питання",
  64:"Мені важко підтримувати розмову з людьми, з якими я тільки що познайомився",
  65:"Коли я намагаюся щось зробити, то часто помічаю, що у мене тремтять руки",
  66:"Руки у мене такі ж спритні і моторні, як і раніше",
  67:"Велику частину часу я відчуваю загальну слабкість",
  68:"Іноді, коли я збентежений я сильно вкриваюся потом і мене це дратує",
  69:"Буває, що я відкладаю на завтра те, що повинен зробити сьогодні",
  70:"Думаю, що я людина приречена",
  71:"Бували випадки, що мені було важке утриматися від того, щоб що-небудь не поцупити в кого-небудь або де-небудь, наприклад у магазині",
  72:"Я зловживав спиртними напоями",
  73:"Я часто про що-небудь турбуюся",
  74:"Мені б хотілося бути членом декількох кружків або зборів",
  75:"Я рідко задихаюся, і у мене не буває сильного серцебиття",
  76:"Все своє життя я суворо дотримуюсь принципів, заснованих на почутті обов’язку",
  77:"Траплялося, що я перешкоджав або поступав наперекір людям просто із принципу, а не тому, що справа була дійсно важливою",
  78:"Якщо мені не загрожує штраф і машин поблизу немає, я можу перейти вулицю там, де бажаю, а не там де потрібно",
  79:"Я завжди був незалежним і вільним від контролю з боку сім'ї",
  80:"У мене бували періоди такої сильної стурбованості, що я навіть не міг всидіти на місці",
  81:"Часто мої вчинки тлумачилися не вірно",
  82:"Мої батьки і (або) інші члени моєї сім’ї прискіпуються до мене більше, ніж треба",
  83:"Хтось керує моїми думками",
  84:"Люди байдужі до того, що з тобою трапиться",
  85:"Мені подобається бути в компанії, де всі жартують один над одним",
  86:"В школі я засвоював матеріал повільніше, аніж інші",
  87:"Я цілком впевнений у собі",
  88:"Нікому не довіряти – найбезпечніше",
  89:"Раз на тиждень або частіше я буваю дуже збудженим і схвильованим",
  90:"Коли я знаходжуся в компанії, мені важко знайти відповідну тему для розмови",
  91:"Мені легко примусити інших людей боятися мене, і іноді я це роблю ради забави",
  92:"У грі я вважаю за краще вигравати",
  93:"Безглуздо засуджувати людину, яка обдурила того, хто сам дозволяє себе обдурювати",
  94:"Хтось намагається впливати на мої думки",
  95:"Я щодня випиваю багато води",
  96:"Щасливіше всього я буваю наодинці",
  97:"Я обурююся кожного разу, коли дізнаюся, що злочинець з якої-небудь  причини залишився безкарним",
  98:"У моєму житті був один або декілька випадків, коли я відчував, що хтось за допомогою гіпнозу примушує мене скоювати ті або інші вчинки",
  99:"Я дуже рідко заговорюю з людьми першим",
  100:"У мене ніколи не було зіткнень із законом",
  101:"Мені приємно мати серед своїх знайомих значних людей, це як би додає мені вагу у власних очах",
  102:"Іноді без жодної причини у мене раптом наступають періоди незвичайної веселості",
  103:"Життя для мене майже завжди пов'язано з напругою",
  104:"У школі мені було дуже важко виступати перед класом",
  105:"Люди проявляють по відношенні до мене стільки співчуття і симпатії, наскільки я заслуговую",
  106:"Я відмовляюся грати в деякі ігри, тому що це у мене погано виходить",
  107:"Мені здається, що я знаходжу друзів з такою ж легкістю, як і інші",
  108:"Мені неприємно, коли навколо мене є люди",
  109:"Як правило, мені не везе",
  110:"Мене легко збити з пантелику",
  111:"Деякі з членів моєї сім'ї скоювали вчинки, які мене лякали",
  112:"Іноді у мене бувають напади сміху або плачу, з якими я ніяк не можу справитися",
  113:"Мені важко приступити до виконання нового завдання або розпочати нову справу",
  114:"Якби люди не були налаштовані проти мене, я досягнув би у житті набагато більшого",
  115:"Мені здається, що мене ніхто не розуміє",
  116:"Серед моїх знайомих є люди, які мені не подобаються",
  117:"Я легко втрачаю терпіння з людьми",
  118:"Часто у новій обстановці я переживаю почуття тривоги",
  119:"Часто мені хочеться померти",
  120:"Іноді я такий збуджений, що мені важко заснути",
  121:"Часто я переходжу на іншу сторону вулиці, щоб уникнути зустрічі з тим, кого я побачив",
  122:"Бувало, що я кидав почату справу, оскільки боявся, що я не справлюся з нею",
  123:"Майже щодня трапляється що-небудь, що лякає мене",
  124:"Навіть серед людей я зазвичай відчуваю себе самотнім",
  125:"Я переконаний, що існує лише одне єдине правильне розуміння значення життя",
  126:"В гостях я частіше сиджу де-небудь осторонь або розмовляю з ким-небудь одним, ніж беру участь у загальних розвагах",
  127:"Мені часто кажуть, що я запальний",
  128:"Буває, що я з ким-небудь пліткую",
  129:"Часто мені неприємно, коли я намагаюся застерегти кого-небудь від помилок, а мене розуміють неправильно",
  130:"Я часто звертаюся до людей за порадою",
  131:"Часто, навіть тоді, коли усе для мене складається добре, я відчуваю що мені усе байдуже",
  132:"Мене досить важко вивести з себе",
  133:"Коли я намагаюся вказати людям на їх помилки або допомогти вони часто розуміють мене неправильно",
  134:"Зазвичай я спокійний, і мене нелегко вивести з душевної рівноваги",
  135:"Я заслуговую суворого покарання за свою провину",
  136:"Мені притаманно так сильно переживати свої розчарування, що я не можу примусити себе не думати про них",
  137:"Часом мені здається, що я ні на що не здатний",
  138:"Бувало, що під час обговорення деяких питань я, особливо не замислюючись, погоджувався з думкою інших",
  139:"Мене дуже турбують різного роду нещастя",
  140:"Мої переконання і погляди непохитні",
  141:"Я вважаю, що можна не порушуючи закон спробувати знайти в ньому лазівку",
  142:"Є люди, які мені настільки неприємні, що я в глибині душі радію, коли вони одержують прочухан за що-небудь",
  143:"У мене бували періоди, коли через хвилювання я втрачав сон",
  144:"Я відвідую різні суспільні заходи, тому що це дозволяє бувати мені серед людей",
  145:"Можна пробачити людям порушення тих правил, які вони вважають нерозсудливими",
  146:"У мене є погані звички, які є настільки сильними, що боротися з ними просто марно",
  147:"Я охоче знайомлюся з новими людьми",
  148:"Буває, що непристойний жарт у мене викликає сміх",
  149:"Якщо справа йде у мене погано, то мені відразу хочеться все кинути",
  150:"Я вважаю за краще діяти відповідно до  власних планів, а не слідувати вказівкам інших",
  151:"Мені подобається, коли оточуючі знають мою точку зору.",
  152:"Якщо я поганої думки про людину або навіть зневажаю його, я мало прагну приховати це від нього",
  153:"Я людина нервова і легко збудлива",
  154:"Все у мене виходить погано, не так як треба",
  155:"Майбутнє здається мені безнадійним",
  156:"Люди досить легко можуть змінити мою думку, навіть якщо до цього вона здавалася мені остаточною",
  157:"Кілька разів на тиждень у мене буває таке відчуття, що повинно трапитися щось жахливе",
  158:"Значну частину часу я відчуваю себе втомленим",
  159:"Я люблю бувати на вечорах і просто в компаніях",
  160:"Я прагну відхилитися від конфліктів і скрутних положень",
  161:"Мене дуже дратує те, що я забуваю, куди кладу речі",
  162:"Пригодницькі розповіді мені подобаються більше, ніж розповіді про любов",
  163:"Якщо я схочу зробити щось, але оточуючі вважають, що цього робити не варто, я можу легко відмовитися від своїх намірів",
  164:"Безглуздо засуджувати людей, які прагнуть урвати від життя все, що можуть",
  165:"Мені байдуже, що про мене думають інші",
  166:"Я абсолютно не пристосований до військової служби і це мене дуже лякає",
  167:"Я переконаний, що чоловіки повинні служити у Збройних Силах тільки за власним бажанням",
  168:"Останнім часом у мене все частіше і частіше трапляються „промахи” і невдачі по службі.",
  169:"Найбільші труднощі для мене під час служби – це необхідність підкорятися командирам і начальникам",
  170:"Тим правилами, які, на мій погляд, несправедливі, я завжди прагну протидіяти",
  171:"Мені хотілося б випробувати себе серйозною і небезпечною справою",
  172:"Мене довго не залишає відчуття образи, заподіяне товаришами",
  173:"Жити за військовим розпорядком для мене просто нестерпно",
  174:"Я сумніваюся, чи зможу я зі своїм здоров'ям витримати всі навантаження військової служби",
  175:"Я заздрю тим, хто зміг ухилитися від військової служби",
  176:"Я відчуваю все більше і більше розчарувань по відношенню до моєї військової спеціальності",
  177:"Я часто розгублююся у складних і небезпечних ситуаціях",
  178:"Мені хотілося б служити у ПДВ або частинах спецназу",
  179:"Із службою у мене ніщо не виходить (не „клеїться”). Часто думаю: „не моя це справа”",
  180:"Коли мною хтось командує, це викликає у мене відчуття протесту",
  181:"Мені завжди було важко пристосовуватися до нового колективу",
  182:"Під час подальшої служби я був би не проти послужити там, де небезпечно і де ведуться бойові дії ",
  183:"Присяга на вірність Вітчизні у сучасних умовах втратила свою актуальність",
  184:"Мені завжди було нелегко пристосовуватися до нових умов життя",
  185:"У складних ситуаціях я не можу швидко приймати правильні рішення",
  186:"Я упевнений, що в майбутньому не стану укладати або продовжувати контракт на продовження військової служби",
  187:"У мене бувають періоди похмурої дратівливості, під час яких я „зриваю зло” на оточуючих",
  188:"Я насилу витримую фізичні навантаження, пов’язані з моєю професійною діяльністю",
  189:"Я достатньо спокійно відношуся до необхідності брати участь в тривалих і небезпечних відрядженнях",
  190:"Навряд чи я схочу присвятити все своє життя військовій професії (залишитися на службу за контрактом, поступити у військове училище)",
  191:"„За компанію” з товаришами я можу прийняти неабияку кількість алкоголю (перевищити свою звичайну „норму”)",
  192:"У компаніях, де я часто буваю, друзі іноді палять „травичку”. Я їх за це не засуджую",
  193:"Останнім часом, щоб не „зірватися”, я був вимушений приймати заспокійливі ліки",
  194:"Мої батьки (родичі) часто виказували побоювання у зв'язку з моїми випивками",
  195:"Немає нічого поганого, коли люди намагаються випробувати на собі незвичайні стани, приймаючи деякі речовини",
  196:"У стані агресії я здатний багато на що",
  197:"Я крутий і жорстокий з оточуючими",
  198:"Якщо хтось заподіяв мені зло, я вважаю зобов'язаним відплатити йому тим же („око за око, зуб за зуб”)",
  199:"Можна погодитися з тим, що я не дуже-то схильний виконувати багато наказів, вважаючи їх безрозсудними",
  200:"Я думаю, що будь-яке положення законів і військових статутів можна тлумачити двояко"
  };

  // Ключі шкал: перелік номерів питань, що зараховуються як «Так» / «Ні»
  const KEYS = {
    D:{ yes:[1,10,19,31,51,69,78,92,101,116,128,138,148], no:[] },
    PR:{ yes:[4,6,7,8,11,12,15,16,17,18,20,21,28,29,30,36,37,39,40,41,47,57,60,63,65,67,68,70,73,80,82,83,84,86,89,94,95,96,98,102,103,108,109,110,111,112,113,115,117,118,119,120,122,123,124,125,127,129,131,135,136,137,139,143,146,149,153,154,155,156,157,158,161,162], no:[2,3,5,23,25,32,38,44,45,52,53,54,55,58,62,66,75,87,105,132,134,140] },
    KP:{ yes:[9,24,27,43,46,61,64,81,88,90,99,104,106,114,121,126,133,142,151,152], no:[26,34,35,48,49,74,85,107,130,144,147,159] },
    MN:{ yes:[14,22,33,42,50,56,59,71,72,77,79,91,93,141,145,150,164,165], no:[13,76,97,100,160,163] },
    VPS:{ yes:[166,167,168,169,170,172,173,174,175,176,177,179,180,181,183,184,185,186,187,188,190], no:[171,178,182,189] },
    DAP:{ yes:[6,9,14,15,22,36,39,42,47,50,56,59,71,72,91,93,117,127,141,145,151,152,164,191,192,193,194,195,196,197,198,199,200], no:[13,100,163] },
    SR:{ yes:[4,8,10,28,29,39,41,47,70,84,115,119,124,136,137,149,154,155], no:[32,105] }
  };

  // Конвертація «сирих» балів у стени
  const RAW_TO_STEN = {
    PR:[
      {sten:1, type:'>=', min:57},
      {sten:2, type:'range', min:46, max:56},
      {sten:3, type:'range', min:35, max:45},
      {sten:4, type:'range', min:27, max:34},
      {sten:5, type:'range', min:19, max:26},
      {sten:6, type:'range', min:13, max:18},
      {sten:7, type:'range', min:9, max:12},
      {sten:8, type:'range', min:6, max:8},
      {sten:9, type:'==', min:5},
      {sten:10, type:'range', min:0, max:4}
    ],
    KP:[
      {sten:1, type:'>=', min:23},
      {sten:2, type:'range', min:20, max:22},
      {sten:3, type:'range', min:18, max:19},
      {sten:4, type:'range', min:15, max:17},
      {sten:5, type:'range', min:13, max:14},
      {sten:6, type:'range', min:11, max:12},
      {sten:7, type:'range', min:9, max:10},
      {sten:8, type:'range', min:7, max:8},
      {sten:9, type:'==', min:6},
      {sten:10, type:'range', min:0, max:5}
    ],
    MN:[
      {sten:1, type:'>=', min:17},
      {sten:2, type:'==', min:16},
      {sten:3, type:'range', min:14, max:15},
      {sten:4, type:'range', min:12, max:13},
      {sten:5, type:'range', min:10, max:11},
      {sten:6, type:'range', min:8, max:9},
      {sten:7, type:'==', min:7},
      {sten:8, type:'range', min:5, max:6},
      {sten:9, type:'==', min:4},
      {sten:10, type:'range', min:0, max:3}
    ],
    VPS:[
      {sten:1, type:'range', min:18, max:25},
      {sten:2, type:'range', min:16, max:17},
      {sten:3, type:'range', min:14, max:15},
      {sten:4, type:'range', min:11, max:13},
      {sten:5, type:'range', min:8, max:10},
      {sten:6, type:'range', min:5, max:7},
      {sten:7, type:'==', min:4},
      {sten:8, type:'range', min:2, max:3},
      {sten:9, type:'==', min:1},
      {sten:10, type:'==', min:0}
    ],
    DAP:[
      {sten:1, type:'>=', min:25},
      {sten:2, type:'range', min:21, max:24},
      {sten:3, type:'range', min:18, max:20},
      {sten:4, type:'range', min:15, max:17},
      {sten:5, type:'range', min:12, max:14},
      {sten:6, type:'range', min:10, max:11},
      {sten:7, type:'range', min:8, max:9},
      {sten:8, type:'range', min:6, max:7},
      {sten:9, type:'range', min:4, max:5},
      {sten:10, type:'range', min:0, max:3}
    ],
    SR:[
      {sten:1, type:'>=', min:15},
      {sten:2, type:'range', min:10, max:14},
      {sten:3, type:'range', min:7, max:9},
      {sten:4, type:'range', min:5, max:6},
      {sten:5, type:'==', min:4},
      {sten:6, type:'==', min:3},
      {sten:7, type:'==', min:2},
      {sten:8, type:'==', min:1},
      {sten:9, type:'==', min:0},
      {sten:10, type:'==', min:0}
    ]
  };

  // ОАП: сума ПР+КП+МН → стен
  const OAP_TO_STEN = [
    {sten:1, type:'>=', min:87},
    {sten:2, type:'range', min:75, max:86},
    {sten:3, type:'range', min:63, max:74},
    {sten:4, type:'range', min:51, max:62},
    {sten:5, type:'range', min:40, max:50},
    {sten:6, type:'range', min:31, max:39},
    {sten:7, type:'range', min:25, max:30},
    {sten:8, type:'range', min:21, max:24},
    {sten:9, type:'range', min:18, max:20},
    {sten:10,type:'<=', max:17}
  ];

  // Короткі інтерпретації (для таблиці)
  const SHORT_DESC = {
    PR:{10:"Вкрай низька НПС...",9:"Вкрай низька НПС",8:"Висока НПС",7:"Достатньо висока",6:"Достатня",5:"В цілому достатня",4:"Дещо понижена",3:"Ознаки нестійкості",2:"Виражена нестійкість",1:"Вкрай висока нестійкість"},
    KP:{10:"Вкрай низький КП",9:"Нижче середнього",8:"Високий КП",7:"Достатньо високий",6:"Достатній",5:"Середній",4:"Задовільний",3:"Понижений",2:"Низький",1:"Вкрай низький"},
    MN:{10:"Вкрай низька соціалізація",9:"Низька соціалізація",8:"Висока соціалізація",7:"Достатньо висока",6:"Достатня",5:"В цілому достатня",4:"Задовільна",3:"Недостатня",2:"Низька",1:"Вкрай низька"},
    VPS:{10:"Низька ВП спрямованість",9:"Низька",8:"Висока",7:"Достатньо висока",6:"Достатня",5:"В цілому достатня",4:"Недостатня",3:"Низька",2:"Низька",1:"Низька"},
    DAP:{10:"Низький ризик девіацій",9:"Низький ризик",8:"Низький ризик",7:"Низький ризик",6:"Низький ризик",5:"Окремі ознаки",4:"Деякі ознаки",3:"Виражені ознаки",2:"Висока імовірність",1:"Дуже висока імовірність"},
    SR:{10:"Відсутність ризику",9:"Відсутність ризику",8:"Окремі ознаки",7:"Окремі ознаки",6:"Ознак не виявлено",5:"Окремі труднощі",4:"Окремі ознаки",3:"Окремі ознаки",2:"Виражені ознаки",1:"Виражені ознаки"}
  };

  const OAP_LEVELS = [
    {sten:1, level:4, label:"низька стійкість", desc:"Недостатній рівень, не відповідає вимогам бойової діяльності"},
    {sten:2, level:4, label:"низька стійкість", desc:""},
    {sten:3, level:3, label:"задовільна стійкість", desc:"Мінімально відповідає вимогам"},
    {sten:4, level:3, label:"задовільна стійкість", desc:""},
    {sten:5, level:2, label:"достатня стійкість", desc:"В основному відповідає вимогам"},
    {sten:6, level:2, label:"достатня стійкість", desc:""},
    {sten:7, level:2, label:"достатня стійкість", desc:""},
    {sten:8, level:1, label:"висока стійкість", desc:"Повністю відповідає вимогам"},
    {sten:9, level:1, label:"висока стійкість", desc:""},
    {sten:10,level:1, label:"висока стійкість", desc:""}
  ];
  // --- кінець 1-ї половини ---
  // === Логіка → допоміжні перетворення ===
  function stenFromRaw(scale, raw){
    const rules = RAW_TO_STEN[scale];
    if(!rules) return null;
    for(const r of rules){
      if(r.type==='>=' && raw>=r.min) return r.sten;
      if(r.type==='<=' && raw<=r.max) return r.sten;
      if(r.type==='==' && raw===r.min) return r.sten;
      if(r.type==='range' && raw>=r.min && raw<=r.max) return r.sten;
    }
    return null;
  }
  function oapSten(sum){
    for(const r of OAP_TO_STEN){
      if(r.type==='>=' && sum>=r.min) return r.sten;
      if(r.type==='<=' && sum<=r.max) return r.sten;
      if(r.type==='range' && sum>=r.min && sum<=r.max) return r.sten;
    }
    return null;
  }

  // Розширені пояснення (адаптуються під стен)
  const SCALE_LABEL = {PR:'ПР — поведінкова регуляція', KP:'КП — комунікативний потенціал', MN:'МН — моральна нормативність', VPS:'ВПС — військово-професійна спрямованість', DAP:'ДАП — девіантна поведінка', SR:'СР — суїцидальний ризик'};
  const LONG_DESC = {
    PR:{vlow:'Виражена емоційна напруга, імпульсивність, труднощі самоконтролю. Потрібні ресурси відновлення і техніки саморегуляції.', low:'Понижена стійкість до стресу; попрацюйте зі сном і відпочинком.', avg:'Функціональний рівень регуляції; можливі ситуативні коливання.', high:'Добра саморегуляція, адаптивні стратегії.', vhigh:'Висока стійкість у складних умовах.'},
    KP:{vlow:'Труднощі встановлення контактів, уникання взаємодії.', low:'Знижена соціальна впевненість.', avg:'Комунікація достатня, ситуаційно ефективна.', high:'Гнучка взаємодія в групі.', vhigh:'Високий вплив і впевненість; ефективний командний учасник/лідер.'},
    MN:{vlow:'Норми нестабільні; ризик порушень у стресі.', low:'Труднощі дотримання правил у конфліктах.', avg:'Норми приймаються в цілому достатньо.', high:'Стійкі етичні орієнтири.', vhigh:'Висока нормативність, розвинений внутрішній контроль.'},
    VPS:{vlow:'Низька військово-професійна мотивація.', low:'Мотивація нестійка, можливе уникання завдань.', avg:'Достатня включеність у діяльність.', high:'Збалансована спрямованість, прийняття вимог служби.', vhigh:'Висока готовність до складних завдань.'},
    DAP:{vlow:'Дуже висока імовірність девіацій (агресія, зловживання, порушення). Потрібна профілактика/корекція.', low:'Висока імовірність девіацій; необхідні превентивні заходи.', avg:'Окремі ознаки; контролювати тригери.', high:'Низький ризик; самоконтроль достатній.', vhigh:'Низький ризик; зрілі механізми контролю поведінки.'},
    SR:{vlow:'Виражений суїцидальний ризик — негайна оцінка фахівцем.', low:'Підвищені тенденції — рекомендована консультація.', avg:'Окремі труднощі настрою/сенсу.', high:'Ознак ризику не виявлено.', vhigh:'Відсутність клінічно значущих ознак ризику.'}
  };
  const answers = {}; // { [qNum]: 'yes'|'no' }
  let page = 0; const perPage = 10;

  // Рендер однієї сторінки питань
  function renderQuestions(){
    const container = document.getElementById('questions');
    container.innerHTML = '';
    const start = page*perPage + 1;
    const end = Math.min(start+perPage-1, 200);
    for(let i=start;i<=end;i++){
      const wrap = document.createElement('div'); wrap.className='q'+(i===end?' no-border':'');
      const num = document.createElement('div'); num.className='q-num'; num.textContent=i;
      const text = document.createElement('div'); text.className='q-text'; text.textContent=QUESTIONS[i] || `Питання ${i}`;
      const actions = document.createElement('div'); actions.className='q-actions';
      const yesId = `q${i}_y`, noId=`q${i}_n`;
      actions.appendChild(choice(yesId,i,'yes','Так'));
      actions.appendChild(choice(noId,i,'no','Ні'));
      wrap.appendChild(num); wrap.appendChild(text); wrap.appendChild(actions);
      container.appendChild(wrap);
    }
    updateProgress();
  }
  function choice(id, i, val, label){
    const lab = document.createElement('label'); lab.className='choice';
    const inp = document.createElement('input'); inp.type='radio'; inp.name=`q${i}`; inp.id=id; inp.value=val;
    if(answers[i]===val) inp.checked = true;
    inp.addEventListener('change', ()=>{ answers[i]=val; updateProgress(); saveState(); });
    const span = document.createElement('span'); span.textContent=label;
    lab.appendChild(inp); lab.appendChild(span);
    return lab;
  }
  function updateProgress(){
    const answered = Object.keys(answers).length;
    const p1 = document.getElementById('progressBar');
    const p2 = document.getElementById('progressBar2');
    if(p1) p1.style.width = (answered/200*100).toFixed(2)+'%';
    if(p2) p2.style.width = (answered/200*100).toFixed(2)+'%';
    const a = document.getElementById('answered'); if(a) a.textContent = answered;
  }

  // Обчислення «сирих» балів за ключами
  function computeRaw(){
    const raw = {D:0, PR:0, KP:0, MN:0, VPS:0, DAP:0, SR:0};
    for(const [scale,key] of Object.entries(KEYS)){
      const {yes=[], no=[]} = key;
      yes.forEach(n=>{ if(answers[n]==='yes') raw[scale]++; });
      no.forEach(n=>{ if(answers[n]==='no')  raw[scale]++; });
    }
    return raw;
  }

  // Допоміжне: з діапазону стен → словесна «смуга»
  function bandFromSten(st){ if(st>=9) return 'vhigh'; if(st>=7) return 'high'; if(st>=5) return 'avg'; if(st>=3) return 'low'; return 'vlow'; }
  function buildNarrativesView(stens){
    const wrap = document.getElementById('narratives');
    if(!wrap) return;
    wrap.innerHTML='';
    ['PR','KP','MN','VPS','DAP','SR'].forEach(code=>{
      const st = stens[code]; if(st==null) return;
      const band = bandFromSten(st);
      const card = document.createElement('div'); card.className='kpi';
      const title = `${SCALE_LABEL[code]} — стен ${st}`;
      const text = LONG_DESC[code]?.[band] || '';
      card.innerHTML = `<div class="k" style="font-size:14px">${title}</div><div style="margin-top:8px;line-height:1.6">${text}</div>`;
      wrap.appendChild(card);
    });
  }

  // Побудова таблиць результатів
  function buildResults(){
    const raw = computeRaw();
    const validityBad = raw.D>=10;

    // Верхні KPI
    const summary = document.getElementById('summary'); summary.innerHTML='';
    const kpis = [{k:'Достовірність (Д)', v: raw.D, extra: validityBad?'<span class="pill bad">≥ 10 — недостовірно</span>':'<span class="pill good">ОК</span>'}];
    const stens = {};

    if(!validityBad){
      const oapRaw = raw.PR + raw.KP + raw.MN;
      const oapSt = oapSten(oapRaw);
      const oapLvl = OAP_LEVELS.find(x=>x.sten===oapSt) || {level:'?',label:'',desc:''};
      kpis.push({k:'ОАП (сирі)', v:oapRaw},{k:'ОАП (стен)', v:oapSt ?? '—'},{k:'Рівень стійкості', v:`${oapLvl.level} — ${oapLvl.label}`});
      ['PR','KP','MN','VPS','DAP','SR'].forEach(code=>{ stens[code]=stenFromRaw(code, raw[code]); });
    }
    kpis.forEach(item=>{
      const div=document.createElement('div'); div.className='kpi';
      div.innerHTML=`<div class="k">${item.k}</div><div class="v">${item.v}</div>${item.extra?`<div style="margin-top:6px">${item.extra}</div>`:''}`;
      summary.appendChild(div);
    });

    document.getElementById('validityBlock').classList.toggle('hide', !validityBad);

    // Таблиця шкал
    const tbody = document.querySelector('#scalesTable tbody'); tbody.innerHTML='';
    const order=[['PR','ПР — поведінкова регуляція'],['KP','КП — комунікативний потенціал'],['MN','МН — моральна нормативність'],['VPS','ВПС — військово-професійна спрямованість'],['DAP','ДАП — девіантна поведінка'],['SR','СР — суїцидальний ризик']];
    if(!validityBad){
      for(const [code,label] of order){
        const r = raw[code]; const st = stens[code];
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${label}</td><td>${r}</td><td>${st ?? '—'}</td><td class="muted">${SHORT_DESC[code]?.[st] ?? ''}</td>`;
        tbody.appendChild(tr);
      }
    } else {
      const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="4" class="center">Шкали не інтерпретуються через Д ≥ 10.</td>`; tbody.appendChild(tr);
    }

    // Таблиця ОАП
    const oapBody = document.getElementById('oapRow'); oapBody.innerHTML='';
    if(!validityBad){
      const oapRaw = raw.PR + raw.KP + raw.MN; const st = oapSten(oapRaw);
      const lvl = OAP_LEVELS.find(x=>x.sten===st) || {};
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${oapRaw}</td><td>${st}</td><td>${lvl.level} — ${lvl.label}</td><td class="muted">${lvl.desc||''}</td>`;
      oapBody.appendChild(tr);
    } else {
      const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4" class="center">—</td>'; oapBody.appendChild(tr);
    }

    // Наративи
    if(!validityBad){ buildNarrativesView(stens); } else { document.getElementById('narratives').innerHTML='<div class="note">Недоступно при Д ≥ 10.</div>'; }
  }

  // ===== Збереження стану / експорт / імпорт =====
  const LS_KEY_ANS = 'adapt200_answers_v1';
  const LS_KEY_META = 'adapt200_meta_v1';
  const LS_KEY_PAGE = 'adapt200_page_v1';

  function saveState(){
    try{
      localStorage.setItem(LS_KEY_ANS, JSON.stringify(answers));
      localStorage.setItem(LS_KEY_PAGE, String(page));
      localStorage.setItem(LS_KEY_META, JSON.stringify(readMeta()));
    }catch(e){ console.warn('saveState error', e); }
  }
  function loadState(){
    try{
      const a = localStorage.getItem(LS_KEY_ANS); if(a){ const parsed=JSON.parse(a); for(const [k,v] of Object.entries(parsed)) answers[+k]=v; }
      const p = localStorage.getItem(LS_KEY_PAGE); if(p!=null) page = Math.max(0, Math.min(19, parseInt(p,10)||0));
      const m = localStorage.getItem(LS_KEY_META); if(m) writeMeta(JSON.parse(m));
    }catch(e){ console.warn('loadState error', e); }
  }

  function readMeta(){
    // беремо з верхніх інпутів; якщо порожні — з нижніх (резерв)
    const get = id => (document.getElementById(id)?.value || '').trim();
    const pref = v => v || '';
    return {
      fi: pref(get('fi') || get('fi2')),
      im: pref(get('im') || get('im2')),
      po: pref(get('po') || get('po2')),
      dob: pref(get('dob')|| get('dob2')),
      unit:pref(get('unit')||get('unit2')),
      date:pref(get('date')||get('date2'))
    };
  }
  function writeMeta(meta={}){
    ['fi','im','po','dob','unit','date','fi2','im2','po2','dob2','unit2','date2'].forEach(id=>{
      const key = id.replace(/2$/,''); const el=document.getElementById(id);
      if(el && meta[key]!=null) el.value = meta[key];
    });
  }

  function clearAll(){
    for(let i=1;i<=200;i++) delete answers[i];
    page=0;
    writeMeta({fi:'',im:'',po:'',dob:'',unit:'',date:''});
    try{
      localStorage.removeItem(LS_KEY_ANS);
      localStorage.removeItem(LS_KEY_META);
      localStorage.removeItem(LS_KEY_PAGE);
    }catch(e){}
    renderQuestions(); updateProgress();
  }

  function saveJSON(){
    const payload={answers, meta: readMeta()};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download = makeFilename() + '.json'; a.click();
    URL.revokeObjectURL(url);
  }
  function loadJSON(file){
    const reader=new FileReader();
    reader.onload=()=>{
      const data=JSON.parse(reader.result);
      if(data && data.answers){ for(const [k,v] of Object.entries(data.answers)) answers[+k]=v; }
      if(data && data.meta){ writeMeta(data.meta); }
      renderQuestions(); updateProgress(); saveState();
    };
    reader.readAsText(file);
  }

function formatDateForFilename(d=new Date()){
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; // YYYY-MM-DD
}
function sanitizeFilename(name){
  return name.replace(/[\\\/:*?"<>|]+/g,'·').replace(/\s+/g,' ').trim();
}
function makeFilename(testName='АДАПТИВНІСТЬ-200'){
  const m = readMeta?.() || {};
  const first = (m.im || 'Без імені').trim();
  const last  = (m.fi || '').trim();
  const date  = formatDateForFilename(new Date()); // дата ЗБЕРЕЖЕННЯ
  const base  = `${first}${last?` ${last}`:''} - ${date} - ${testName}`;
  return sanitizeFilename(base);
}


  function exportPDF(){
    // Заповнити друковане полотно
    const m = readMeta();
    document.getElementById('p_fi').textContent=m.fi;
    document.getElementById('p_im').textContent=m.im;
    document.getElementById('p_po').textContent=m.po;
    document.getElementById('p_dob').textContent=m.dob;
    document.getElementById('p_unit').textContent=m.unit;
    document.getElementById('p_date').textContent=m.date;

    const raw = computeRaw();
    const validityBad = raw.D>=10;
    const tbody = document.getElementById('printScales'); tbody.innerHTML='';
    if(!validityBad){
      const order=[['PR','ПР'],['KP','КП'],['MN','МН'],['VPS','ВПС'],['DAP','ДАП'],['SR','СР']];
      for(const [code,short] of order){
        const r = raw[code]; const st = stenFromRaw(code, r);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${short}</td><td>${r}</td><td>${st ?? '—'}</td><td>${SHORT_DESC[code]?.[st] ?? ''}</td>`;
        tbody.appendChild(tr);
      }
    } else {
      const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4">Д ≥ 10 — інтерпретація не надається</td>'; tbody.appendChild(tr);
    }
    const oapBody=document.getElementById('printOAP'); oapBody.innerHTML='';
    if(!validityBad){
      const oapRaw=raw.PR+raw.KP+raw.MN; const st=oapSten(oapRaw); const lvl=OAP_LEVELS.find(x=>x.sten===st)||{};
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${oapRaw}</td><td>${st}</td><td>${lvl.level} — ${lvl.label}</td><td>${lvl.desc||''}</td>`;
      oapBody.appendChild(tr);
    }else{
      const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4">—</td>'; oapBody.appendChild(tr);
    }

    document.getElementById('printSheet').classList.remove('hide');
    window.print();
    document.getElementById('printSheet').classList.remove('hide');
     const prevTitle = document.title;
     document.title = makeFilename();            // <- тимчасовий title = бажане ім’я
     window.print();
     setTimeout(()=>{
       document.getElementById('printSheet').classList.add('hide');
       document.title = prevTitle;               // <- повертаємо назву сторінки
     }, 500);
  }

  // ===== Події / навігація =====
  function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
  function nextPage(){ page=clamp(page+1,0,19); renderQuestions(); saveState(); }
  function prevPage(){ page=clamp(page-1,0,19); renderQuestions(); saveState(); }

  // Кнопки (верхні)
  document.getElementById('btnNext') .onclick=nextPage;
  document.getElementById('btnPrev') .onclick=prevPage;
  document.getElementById('btnFinish').onclick=()=>{ document.getElementById('results').classList.remove('hide'); buildResults(); window.scrollTo({top:document.getElementById('results').offsetTop-10,behavior:'smooth'}); saveState(); };
  document.getElementById('btnClear').onclick=()=>{ for(let i=1;i<=200;i++) delete answers[i]; renderQuestions(); updateProgress(); saveState(); };
  document.getElementById('btnResetAll').onclick=()=>{ if(confirm('Очистити всі дані і розпочати спочатку?')){ clearAll(); saveState(); } };
  document.getElementById('btnExportPDF').onclick=exportPDF;

  // Кнопки (середні/нижні дублікати)
  document.getElementById('btnNext2').onclick=nextPage;
  document.getElementById('btnPrev2').onclick=prevPage;
  document.getElementById('btnFinish2').onclick=()=>{ document.getElementById('results').classList.remove('hide'); buildResults(); saveState(); };

  document.getElementById('btnNext3').onclick=nextPage;
  document.getElementById('btnPrev3').onclick=prevPage;
  document.getElementById('btnFinish3').onclick=()=>{ document.getElementById('results').classList.remove('hide'); buildResults(); saveState(); };

  // Кнопки у блоці результатів
  document.getElementById('btnSave').onclick=saveJSON;
  document.getElementById('fileLoad').addEventListener('change',e=>{ if(e.target.files?.[0]) loadJSON(e.target.files[0]); });
  document.getElementById('btnExportPDF2').onclick=exportPDF;
  document.getElementById('btnResetAll2').onclick=()=>{ if(confirm('Очистити всі дані і розпочати спочатку?')){ clearAll(); saveState(); } };

  // Ввід метаданих → автосейв
  ['fi','im','po','dob','unit','date','fi2','im2','po2','dob2','unit2','date2'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('input', saveState);
  });

  // Ініціалізація
  loadState();
  renderQuestions();
  updateProgress();
  </script>
</body>
</html>
